name: Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  
permissions:
  contents: read
  actions: write

jobs:

  sast-bandit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Bandit
        run: pip install bandit[toml]
      
      - name: Run Bandit Scan
        run: |
          bandit -r . -f json -o bandit-report.json --exclude ./venv,./tests
          bandit -r . -f html -o bandit-report.html --exclude ./venv,./tests
        continue-on-error: true
      
      - name: Upload Bandit Results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: |
            bandit-report.json
            bandit-report.html

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
    
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
    
      - name: Install dependencies
        run: pip install -r requirements.txt
    
      - name: Install Safety
        run: pip install safety
    
      - name: Run Safety Check
        run: |
          safety check --file=requirements.txt --json > safety-report.json || true
          safety check --file=requirements.txt > safety-report.txt || true
        continue-on-error: true
    
      - name: Upload Safety Report
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: |
            safety-report.json
            safety-report.txt

  build-and-test:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [sast-bandit, dependency-check]
    steps:
      - uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          echo "MYSQL_ROOT_PASSWORD=test-mysql-password-123" > .env
          echo "SECRET_KEY=test-secret-key-for-ci" >> .env
          echo "FLASK_DEBUG=false" >> .env
      
      - name: Build Docker Images
        run: docker compose build
      
      - name: Start Services
        run: docker compose up -d
      
      - name: Wait for Application to be Ready
        run: |
          echo "Waiting for app to start..."
          timeout 60 bash -c 'until curl -sf http://localhost:5000; do sleep 2; done' || exit 1
      
      - name: Test Application Health
        run: |
          curl -I http://localhost:5000
          docker compose ps
      
      - name: Show Application Logs
        if: always()
        run: docker compose logs
      
      - name: Stop Services
        if: always()
        run: docker compose down -v

  dast-zap:
    name: DAST - OWASP ZAP Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    env:
      MYSQL_ROOT_PASSWORD: test-mysql-password-123
      SECRET_KEY: test-secret-key-for-ci
      FLASK_DEBUG: "false"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Start Application
        run: |
          docker compose up -d
          echo "Waiting for services to be ready..."
          sleep 40
      
      - name: Verify Application is Running
        run: |
          curl -f http://localhost:5000 || (docker compose logs && exit 1)
      
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:5000'
          allow_issue_writing: false
          fail_action: false
          artifact_name: 'zapscanreport'
      
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zapscanreport
          path: |
            reporthtml.html
            reportmd.md
            reportjson.json
      
      - name: Show Application Logs
        if: always()
        run: docker compose logs
      
      - name: Stop Application
        if: always()
        run: docker compose down -v
